= Setting up your own Nextcloud with Collabora Office
:jbake-type: page
:jbake-status: published
:jbake-date: 2020-03-21
:jbake-tags: nextcloud, traefik, docker, docker-compose, collabora, code, cloud, letsencrypt,  ssl, office, backup, ubunutu, linux
:jbake-description: How to setup you Nextcloud with docker, traefik, Collabora, office and letsencrypt
:jbake-author: Marc Gorzala
:jbake-disqus_enabled: true
:jbake-disqus_identifier: f184187c-69d1-11ea-b388-87b974545588
:idprefix:
:sectnums:
:sectnumlevels: 5

Author: Marc Gorzala

image::nextcloud-logo-white.png[align="center"]

This post explains how you _could_ setup your own link:https://nextcloud.com/[Nextcloud]
with link:https://www.collaboraoffice.com/code/[Collabora Office] having SSL automatically managed via
link:https://letsencrypt.org[Letsencrypt] and link:https://containo.us/traefik/[Traefik].


*What is Nextcloud?*

Nextcloud offers you to host a service like link:https://www.dropbox.com/[DropBox].

You can have you files synced between different devices like your Desktop/Laptop and
mobile. Additionally you have also a calendar, a todo-list, your contacts and many other things synced
across your devices.

*What is Collabora?*

link:https://www.collaboraoffice.com/code/[Collabora], offers you the functionality of link:https://www.libreoffice.org/[Libre Office]
in your browser. In this tutorial we will integrate Collabora into your Nextcloud
installation, so that you can edit office documents directly in your Nextcloud!

*The installed system will...*

* ... use link:https://de.wikipedia.org/wiki/Hypertext_Transfer_Protocol_Secure[HTTPS]
  to secure the communication with your Nextcloud.
* ... include the Office Suite  link:https://www.collaboraoffice.com/code/[Collabora Office]
* ... separate Code/App from your data, making it easy for you to
** make backups (we will have a basic script for doing backups).
** perform updates.
* ... works behind a (DSL) router as well as on any other server in the cloud
  or elsewhere.

Ready to go? Great!

---

:toc:
:toc-placement: macro
:toclevels: 4
toc::[]


== Prerequisites

* A server that is able to run link:https://www.linux.org/[Linux]
  (this post will assume you are using a Debian/Ubuntu based distribution).
* You have control over DNS entries for a domain that you own. In this tutorial I will assume that
  you will use link:https://en.wikipedia.org/wiki/Subdomain[Subdomains] under `dancier.net`:
** `cloud.dancier.net` - pointing to your Nextcloud installation
** `collabora.dancier.net` - pointing to the installation of the office suite.
  (If you do not want to install the option for editing office files, you do not need this of course)
+
NOTE: The way we are installing the system is that everything is installed on the same machine
      and we need only one IP-address. So both domain names point to this one address.


* Basic knowledge of link:https://en.wikipedia.org/wiki/Linux[Linux] and link:https://www.docker.com/[Docker].

== We will use the following technologies

* link:https://www.docker.com/[Docker] for easy installation/updating of the needed
       software.
* link:https://docs.docker.com/compose/[Docker Compose] for a convenient configuration
       of the docker containers.
* link:https://docs.traefik.io/[Traefik] for automatically maintaining SSL Certificates
       and forwarding requests to either Nextcloud or Collabora Online. In this way it acts
       as an link:https://docs.docker.com/install/linux/docker-ce/ubuntu/[Reverse Proxy].
* link:https://mysql.com/[MySQL] to be used as the database for Nextcloud.
* link:https://www.collaboraoffice.com/code/[Collabora Office]

== Architectural Overview
[[architectural-overview]]
.architectural overview
[plantuml, cloud-architecture, svg]
....
@startuml
 left to right direction
 actor user
 component browser
 boundary wlan_router
 cloud docker {
   database db
   boundary reverse_proxy
   node nextcloud
   node collabora
 }
user --> browser
browser --> wlan_router
wlan_router --> reverse_proxy
reverse_proxy --> nextcloud
reverse_proxy --> collabora
nextcloud --> db

@enduml
....

Let me short describe you this architecture briefly.

. The `user` that is connecting to nextcloud.
. He is using a `browser` (or any other device/app) to make a connection
. The browser connects to the `wlan_router` at your home. This is your
  only component with a public IP-address. The `wlan_router` is configured
  to link:https://en.wikipedia.org/wiki/Port_forwarding[forward every traffic]
  that it receives on its public IP-address on
  Port 443 (the HTTPS port) to the IP-address of you local machine that
  will host your Nextcloud installation on Port 443(to the `reverse_proxy`).
+
NOTE: If you are installing Nextcloud on a server that is directly
      connected to the internet, then this component does not exist,
      and the browser directly connects to the `reverse_proxy`. +
      In this case you of course also need not to configure the mentioned
      port forwarding.
. The `reverse_proxy` is receiving the incoming traffic. It
  will inspect the request to find out to which host it should forward the request to.
+
TIP: If you want to know how the `reverse_proxy` could do this, as the Request is
encrypted, you can read link:https://cwiki.apache.org/confluence/display/HTTPD/NameBasedSSLVHostsWithSNI[this].
(It is using link:https://en.wikipedia.org/wiki/Server_Name_Indication[SNI])
. The `nextcloud` node contains just what the name implies. The main
  program. It will store all your files locally to this.
. The `db` node is the database that is used by `nextcloud` to store everything but files
  (contacts, calendar, ...)
. `collabora` contains the office suite.

Everything that is depicted in the cloud `docker` will be installed on one (docker-)host.

== Setting it up
First of all, we will make sure traffic to our planned domains `cloud.dancier.net`
and `collabora.dancier.net` could reach our system.

=== Check your DNS/IP configuration

All incoming traffic has to reach the `reverse_proxy`. So the DNS should normally
point to the machine you are going to install the system.

TIP: In case you are installing the system on a host behind a `wlan-router`
     (as depicted in above architecture diagram)
     than you have to find out the public IP-address of the router. Use
     this IP-address to configure your DNS entries and forward all traffic
     that reaches your `wlan-router` on PORT 443 to the machine in your
     local net where you are going to install Nextcloud.
     +
     Google for <router brand/type> port forwarding how to do this.

Assuming that the public IP-address is `5.61.144.190` you should get
the following responses when invoking a `nslookup` on the domains:

[source, bash]
----
marc@marc-VirtualBox:~/programm/dancier/documentation$ nslookup cloud.dancier.net
Server:   127.0.0.53
Address:  127.0.0.53#53

Non-authoritative answer:
Name:	 cloud.dancier.net
Address: 5.61.144.190

marc@marc-VirtualBox:~/programm/dancier/documentation$ nslookup collabora.dancier.net
Server:   127.0.0.53
Address:  127.0.0.53#53

Non-authoritative answer:
Name:	 collabora.dancier.net
Address: 5.61.144.190
----

=== Installing basic tools that you need

You need the following tools on the server you are going to install Nextcloud.

 * docker
 * docker-compose
 * git
 * vim (not necessarily needed, but good to have ;-) )

You can install the tools on your own or you can download my script and
execute it with on a fresh Ubuntu-Host that should serve the Nextcloud installation.
If this script will not run on your system, it could give you hints how to install the tools.
The script is also already cloning the repository containing the docker setup for Nextcloud.
The next section will assume the script has been run successfully or at least you have
performed the equivalent steps manually.

Get the script here:

`https://raw.githubusercontent.com/gorzala/nextcloud/master/bootstrap-os.sh`

Copy this script to your server (or download it from there) and execute it.

=== Inspecting the project

Assuming you have already cloned the repository to `/root/nextcloud/`, let's inspect
the project structure:

[source, bash]
----
root@cloud:~/nextcloud# ls -la
total 48
drwxr-xr-x 4 root root 4096 Mar 20 14:28 .
drwx------ 6 root root 4096 Mar 20 14:28 ..
-rwxr-xr-x 1 root root 1113 Mar 20 14:28 bootstrap-os.sh
-rw-r--r-- 1 root root 2379 Mar 20 14:28 docker-compose.yml
-rwxr-xr-x 1 root root  119 Mar 20 14:28 .env-template
drwxr-xr-x 8 root root 4096 Mar 20 14:28 .git
-rw-r--r-- 1 root root   86 Mar 20 14:28 .gitignore
-rw-r--r-- 1 root root  305 Mar 20 14:28 .maintenance.config
-rwxr-xr-x 1 root root 3250 Mar 20 14:28 maintenance.sh
-rw-r--r-- 1 root root 5708 Mar 20 14:28 README.adoc
drwxr-xr-x 3 root root 4096 Mar 20 14:28 update
----

Brief description of the purpose of the files:

 * *bootstrap-os.sh* the script that you maybe already used to install basic tools for this project
 * *docker-compose.yml* configures all the containers that we use and how they work together
 * *.env-template* template for the config file that will hold your database credentials
 * *.git* and *.gitignore* git internals, you can ignore them
 * *.maintenance.config* configures how you will backup/update your system
 * *maintenance.sh* the script for doing a backup and update (not yet complete)
 * *README.adoc* very short explanation how to use this project
 * *update* folder that belongs to updating the system. Maybe not really needed.

Let's have a more in deep look into the files in the following sections. If you don't want to
_waste time_ understanding what you are doing and directly want to configure and start the system,
feel to skip to <<section-configuring-system>>. But I strongly recommmend that you come back to
read _and_ understand what you have configured.

==== Composing your services with docker-compose.yml
To understand what you are doing here, it is important you have some knowledge about docker-compose.

First of all, that name of the folder that contains the docker-compose file is *important*.
Docker-compose will use the name of this folder to create things like networks and others for you. If you have cloned the project like I told
you, this name is `nextcloud`.

So name of created networks and containers will start with this name. So better not change
the name of this folder.

In general, you can think of docker-compose as a way to configure different services that
should act together to fulfill a certain use case. In this case it is, having a full featured
Nextcloud installation with an office suite running.

The different services that we need to configure in this docker compose file are:

Traefik:: that acts as the reverse proxy, forwarding incoming requests to the different internal systems
Nextcloud:: that is our main component
Mysql database:: that stores all the data for and is used by the Nextcloud service
Collabora:: the service that is used to provide the office suite

So already 4 services!

Those services will communicate with each other as shown in figure 1. The service-to-service
communication happens via a private network that docker-compose will create. With this private
network, this communication between these services is shielded from the rest of the docker-host
(and with this also from the internet).

So let's see how these four services are configured:

NOTE: The compose-file is being written in link:https://yaml.org/[Yaml]-Syntax. This is becoming
      someway standard for more and more systems. So if you are not familiar with how to write
      YAML files, learning this will pay off not only for writing docker-compose files.

Let's see the basic structure of the docker-compose file:

.docker-compose.yml (schema)
[source, bash, linenumbers]
----
version: "3"
services:
  traefik:
    [...]
  nextcloud:
    [...]
  mysql:
    [...]
  collabora:
    [...]
----
line 1:: *Version* +
  Specifies that we are using version 3 of the compose file syntax. (This is not the version of
  docker-compose or docker)
line 2:: *Definition of the services* +
  Starts with the the services that we will use. Under this node all services are configured.

In the following we will have a deeper look into the configuration of each service. Some
configurations directives like naming will be explained only once and not for every service, as this
would be to verbose. However, due to this you should read through all the
parts one by one.

===== Traefik
.docker-compose.yml (Traefik part)
[source, bash, linenumbers]
----
  traefik:
    image: "traefik:v2.2"
    command:
      - "--log.level=DEBUG"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.mytlschallenge.acme.tlschallenge=true"
      #- "--certificatesresolvers.mytlschallenge.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory"
      - "--certificatesresolvers.mytlschallenge.acme.email=yourmail@mail.de"
      - "--certificatesresolvers.mytlschallenge.acme.storage=/letsencrypt/acme.json"
    restart: always
    ports:
      - "443:443"
    volumes:
      - "./letsencrypt:/letsencrypt"
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
----

This part configures Traefik, which is our `reverse_proxy`, that forwards all incoming
requests to the other services (see <<architectural-overview>>).

line 1:: *Name* +
         Sets the service-name to 'traefik'. As we do not specify a container name explicitly,
         docker-compose will generate this name: _nextcloud_traefik_1_. Compose will the take
         the name of the folder that contains the compose file, concatenates it with the name
         of the service and a number for that node(we will have only one noce per service, so
         this will be always 1)
line 2:: *Docker image* +
         defines which link:https://hub.docker.com/_/traefik[docker image] to get for traefik
lines 4-11:: *CLI parameters for Traefik* +
         In short: the configuration of traefik is being grouped into static configuration
         (everything that changes rarely(are we working with docker, or kubernetes,...) and
         dynamic configuration for the stuff that changes more frequently. +
         For the static configuration traefik offers three ways:
* File based configuration
* Environment variable configuration.
* _Command line parameter bases configuration_ (I choose to use this option)

line 4:: *Debug log-level* +
         This command-line parameter configured traefik to start in debug mode. This will
         increase the logging volume heavily. Use this when you have problems.
         This is commented out in this example.
line 5:: *Docker provider* +
         This will setup traefik to use the docker-plugin, the provider. Essentially this,
         makes Traefik listen to every container that is started/stopped by Docker.
         Whenever a container starts, it checks if this container is being configured to
         used with Traefik. If so, it creates a route so that incoming traffic will be
         forworded to this service/container. It will also make sure that a valid
         ssl-certifcate is being used.
line 6:: *Docker expose by default* +
         You explicitly have to enable containers to be handled by Traefik.
line 7:: *Entry points* +
         Makes Traefik creating an endpoint named 'websecure' that listens on port 443.
         Traefik will use this endpoint to handle all incoming traffic and route it to the
         respective containers (see <<architectural-overview, figure>>).
line 8-11:: *SSL-configuration* +
         Configures how Traefik should manage certificates.
line 12:: *Restart always* +
         Makes Traefik always automatically restart, in case it crashes.
line 13 - 14:: *Ports* +
         We will only expose (listing on that port on the docker-host) port 443. This is the
         default for HTTPS/SSL
line 15 - 17:: *link:https://docs.docker.com/storage/volumes/[Volumes]* +
         * The Letsencrypt volume is used to store the SSL-certificate related things'.
         * Docker link:https://en.wikipedia.org/wiki/Unix_domain_socket[socket] is someway special: +
           It enables the traefik container to connect to the mentioned socket on the docker-host.
           By connecting to this socket, Traefik is aware of all containers that are started and stopped.
           You will see later why this is important.

===== Nextcloud
.docker-compose.yml (Nextcloud part)
[source, bash, linenumbers]
----
  nextcloud:
    image: nextcloud
    environment:
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
    restart: always
    volumes:
      - ./nextcloud-core:/var/www/html
      - ./nextcloud-apps:/var/www/html/custom_apps
      - ./nextcloud-data/:/var/www/html/data
      - ./nextcloud-config:/var/www/html/config
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nextcloud.rule=Host(`cloud.dancier.net`)"
      - "traefik.http.routers.nextcloud.entrypoints=websecure"
      - "traefik.http.routers.nextcloud.tls.certresolver=mytlschallenge"
      - "traefik.http.middlewares.nextcloud.headers.customresponseheaders.Strict-Transport-Security=max-age=15552000; includeSubDomains"
    depends_on:
      - mysql
      - traefik
----
line 3-5:: *Environment* +
  We are passing two environment variables into the Nextcloud-container...
    * the database name to be used to 'nextcloud'.
    * the database username to be used also to 'nextcloud'.
lines 7 - 11:: *Volumes* +
 * nextcloud-core, this will contain the core part of nextcloud
 * nextcloud-app, this will hold your installed apps (kind of extensions of nextcloud)
 * nextcloud-data, this very likely to be the volume that has to store most.
 * nextcloud-config, this will contain the configuration files the will be read by Nextcloud

lines 12 - 17:: *Labels* +
* *traefik.enable* +
   as I told you in the description of the Traefik-Service, Traefik will be informed by every start and stop of a
   docker container. I will also be able to read the labels associated with the containers. By reading this lable,
   we tell traefik to feel responsible to this service.
* *Rule* +
   This is also read by Traefik and tells it to forward all traffic that has the HTTP-host header set to
  'cloud.dancier.net' to this service.
* *Entry point* +
   Traefik will use this named endpoint (see configuration for Traefik) to consider traffic for Nextcloud
* *Certresolver* +
   Defines which certifcate-generation strategy should be used (we configured also this in the Traefik-part)
* *Strict-Header*
  *Tried to circumvent an error message in the nextcloud backend*

lines 18 - 20:: *Depends on* +
    * Nextcloud needs to have traefik running before being started, as traefik would not be able to configure ssl when it
    starts after nextcloud
    * Nextcloud needs a running database, so we also wait until it is started.

[[mysql]]
===== MySQL
.docker-compose.yml (MySQL part)
[source, bash, linenumbers]
----
  mysql:
    image: mariadb:latest
    command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW
    volumes:
      - ./nextcloud-mysql:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD
      - MYSQL_PASSWORD
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
----
line 3:: *CLI-Parameter* +
 * link:https://dev.mysql.com/doc/refman/8.0/en/innodb-transaction-isolation-levels.html[Database Transaktion level]
    set to `READ_COMIITTED`
 * link:https://mariadb.com/kb/en/binary-log/[Binlog] set to row

+
This is prescribed in link:https://docs.nextcloud.com/server/latest/admin_manual/configuration_database/linux_database_configuration.html[Nextcloud-Admin-Configuration]

lines 6 - 10:: *Environment* +
You, should notice that we configure 4 environment variables here.
Two of them already with a an concret value
 * MYSQL_DATABASE=nextcloud
 * MYSQL_USER=nextcloud
+
This, configures MYSQL to create a database named nextcloud with a user with the same name, that has all rights.
The creation of the database happens only when a database with this name not already exist.
The passwords for these tasks are taken from the next two environment variables.
 * MYSQL_ROOT_PASSWORD
 * MYSQL_PASSWORD
+
They do not have any values. In this case docker compose will take them from a file called `.env` from the
current directory (this could also be overwritten by cli parameters, but in our case we do not care for that option).
In the configuration part, I will tell you how to set this file up.

===== Collabora
.docker-compose.yml (Collabora part)
[source, bash, linenumbers]
----
  collabora:
    image: collabora/code
    restart: always
    environment:
      - domain=cloud\\.dancier\\.net
      - DONT_GEN_SSL_CERT=YES
      - extra_params=--o:ssl.enable=false --o:ssl.termination=true
    depends_on:
      - traefik
    cap_add:
      - MKNOD
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.collabora.rule=Host(`collabora.dancier.net`)"
      - "traefik.http.routers.collabora.entrypoints=websecure"
      - "traefik.http.routers.collabora.tls.certresolver=mytlschallenge"
----
lines 4 - 6:: *Environment* +
              * *domain*, the DNS name of the Nextcloud installation
              * DONT_GEN_SSL_CERT, SSL certifcate management is handeled by Traefik
              * extra_params
              ** as Traefik will terminate SSL (only HTTP reaches this
                 service, not HTTPS), we disable ssl here
              ** we indicate, that SSL was used, but terminated (likely
                 used for link generation, i guess)

+
see link:https://www.collaboraoffice.com/code/docker/[this page] on Collabora Onlline for more help.
lines 9:: *Depends on* +
 ...Traefik for SSL-management.

lines 9-10:: *Adding capablities* +
 MKNOD enables the collabora container to create devices nodes. This could be dangerous (link:https://systemadminspro.com/docker-container-breakout/[link])
 Do we really need this. The Nextcloud documentation comes with examples, containing this
 directive, collabora comes without it. I will try in the future to run without it.
 If you successfully run collabora without this being set, please use the comments to tell me.


[[database-config]]
====  Configuring your database credentials with .env-template
As mentioned in the <<mysql, mysql-part of the docker-compose>> we are configuring the
passwords to be used for the database in an `.env` file. This is the template.
[source, bash, linenumbers]

----
MYSQL_ROOT_PASSWORD=<your-my-sql-root-passwort>
MYSQL_PASSWORD=<the password for accessing the database for nextcloud>
----
We will change this in the <<section-configuring-system, configuration section>>.

==== Maintaining the system with maintenance.sh
This script should cover all maintenance tasks for you while operating
your Nextcloud installation.

Currently, only a simple backup functionality is being implemented. You should
do a backup especially before every update.

We will explain the usage of this script after we had configured it.

==== Configuring the backup with .maintenance.config

This is used by the maintenance script and contains mostly variables for the backup.
We will configure this later.
[source, bash, linenumbers]
----
BASE_FOLDER=/home/marc/programm/nextcloud
NEXTCLOUD_DATA_FOLDER=/mnt/nextcloud-data
LETSENCRYPT=letsencrypt
NEXTCLOUD_APPS=nextcloud-apps
NEXTCLOUD_CONFIG=nextcloud-config
NEXTCLOUD_CORE=nextcloud-core
NEXTCLOUD_MYSQL=nextcloud-mysql

BACKUP_FOLDER=/media/marc/0519a4be-d9ce-4725-81f3-a26d9e577d13/backup
----

[[section-configuring-system]]
=== Configuring the system

Now you should have at least a brief understanding, about the important files.
You also have made sure that the DNS names point to the correct IP-address.

Now we will change some of the files, adapting them to your requirement
and are ready to go.

==== Create .env
You see in the root-directory of the project a file called `.env-template`. As the
name implies, this is only a template. Let's create the file that we will use from it.

[source, bash]
----
root@cloud:~/nextcloud# cp .env-template .env
----

Now edit the file (I would suggest to use vim) and provide the password you want
the mysql-database should use. One is the root password for the db and the other one is
the password for the user 'nextcloud' that is being used by Nextcloud to connect to the
database.

==== Edit docker-compose.yml
Traefik::
You have to edit the email-address for the certificate-generation process.
You can leave the rest as it is. The certifcates will be stored than relativ to the project
in a folder 'letsencrypt'. The folder will be created by docker-compose, if it does not exists.
Nothing do to for you.

Nextcloud::
Just, update the rule entry that it checks for your hostname.

You can leave the rest. All volumes are again relativ to the project root.
Mysql::
Nothing to do here for you.

Collabora::
Only change here the rule for traefik that it matches your domain-name for collabora.
==== First start of the system

==== Change config.php

'overwritehost' => 'cloud.becheftigt.de',
'overwriteprotocol' => 'https',
'overwrite.cli.url' => 'https://cloud.becheftigt.de',

cat 'trusted_proxies' => array('172.18.0.0/16'),


==== Enable I-Phone/Max Sync
for apple support

in nextcloud core.htaccess

RewriteRule ^\.well-known/host-meta https://%{HTTP_HOST}/public.php?service=host-meta [QSA,L]
RewriteRule ^\.well-known/host-meta\.json https://%{HTTP_HOST}/public.php?service=host-meta-json [QSA,L]
RewriteRule ^\.well-known/webfinger https://%{HTTP_HOST}/public.php?service=webfinger [QSA,L]
RewriteRule ^\.well-known/nodeinfo https://%{HTTP_HOST}/public.php?service=nodeinfo [QSA,L]
RewriteRule ^\.well-known/carddav https://%{HTTP_HOST}/remote.php/dav/ [R=301,L]
RewriteRule ^\.well-known/caldav https://%{HTTP_HOST}/remote.php/dav/ [R=301,L]

== Do your first backup

== Some problems that you may have

https://github.com/jowave/vcard2to3

2.1 3.1


== Summary
If you like this How two, link me, show it in the comments! Also, use the comments in case
of questions.

Let's summarize what he have achieved:

* We have an own Nextcloud installation running
* Everything is reachable via valid SSL certificates
* We can sync with Desktops running Windows/Mac and Linux
* We can also sync with mobiles running Android/Mac
* We have an office suite, that enable us to work wherever we are
* We can also easily work together on the very same document at the very same time!

*I hope you like this tutorial and recommend it!*
