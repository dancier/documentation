= Setting up your own Nextcloud with Collabora Office
:jbake-type: page
:jbake-status: published
:jbake-date: 2020-03-15
:jbake-tags: nextcloud, traefik, docker, docker-compose, collabora, code, cloud, letsencrypt,  ssl, office, backup, ubunutu, linux
:jbake-description: How to setup you Nextcloud with docker, traefik, Collabora, office and letsencrypt
:jbake-author: Marc Gorzala
:jbake-disqus_enabled: true
:jbake-disqus_identifier: f184187c-69d1-11ea-b388-87b974545588
:idprefix:

Author: Marc Gorzala

image::nextcloud-logo-white.png[align="center"]

This post explains how you _could_ setup your own link:https://nextcloud.com/[Nextcloud]
with link:https://www.collaboraoffice.com/code/[Collabora Office] having SSL automatically managed via
link:https://letsencrypt.org[Letsencrypt] and link:https://containo.us/traefik/[Traefik].


*What is Nextcloud?*

Nextcloud offers you to host a service like link:https://www.dropbox.com/[DropBox].

You can have you files synced between different devices like your Desktop/Laptop and
mobile. Additionally you have also a calendar, a todo-list, your contacts and many other things synced
across your devices.

*What is Collabora?*

link:https://www.collaboraoffice.com/code/[Collabora], offers you the functionality of link:https://www.libreoffice.org/[Libre Office]
in your browser. In this tutorial we will integrate Collabora into your Nextcloud
installation, so that you can edit office documents directly in your Nextcloud!

*The installed system will...*

* ... use link:https://de.wikipedia.org/wiki/Hypertext_Transfer_Protocol_Secure[HTTPS]
  to secure the communication with your Nextcloud.
* ... include the Office Suite  link:https://www.collaboraoffice.com/code/[Collabora Office]
* ... separate Code/App from your data, making it easy for you to
** make backups (we will have a basic script for doing backups).
** perform updates.
* ... works behind a (DSL) router as well as on any other server in the cloud
  or elsewhere.

Ready to go? Great!

---

:toc:
:toc-placement: macro
:toclevels: 4
toc::[]


== Prerequisites

* A server that is able to run link:https://www.linux.org/[Linux]
  (this post will assume you are using a Debian/Ubuntu based distribution).
* You have control over DNS entries for a domain that you own. In this tutorial I will assume that
  you will use link:https://en.wikipedia.org/wiki/Subdomain[Subdomains] under `dancier.net`:
** `cloud.dancier.net` - pointing to your Nextcloud installation
** `collabora.dancier.net` - pointing to the installation of the office suite.
  (If you do not want to install the option for editing office files, you do not need this of course)
+
NOTE: The way we are installing the system is that everything is installed on the same machine
      and we need only one IP-address. So both domain names point to this one address.


* Basic knowledge of link:https://en.wikipedia.org/wiki/Linux[Linux] and link:https://www.docker.com/[Docker].

== We will use the following technologies

* link:https://www.docker.com/[Docker] for easy installation/updating of the needed
       software.
* link:https://docs.docker.com/compose/[Docker Compose] for a convenient configuration
       of the docker containers.
* link:https://docs.traefik.io/[Traefik] for automatically maintaining SSL Certificates
       and forwarding requests to either Nextcloud or Collabora Online. In this way it acts
       as an link:https://docs.docker.com/install/linux/docker-ce/ubuntu/[Reverse Proxy].
* link:https://mysql.com/[MySQL] to be used as the database for Nextcloud.
* link:https://www.collaboraoffice.com/code/[Collabora Office]

== Architectural Overview
.architectural overview
[plantuml, cloud-architecture, svg]
....
@startuml
 left to right direction
 actor user
 component browser
 boundary wlan_router
 cloud docker {
   database db
   boundary reverse_proxy
   node nextcloud
   node collabora
 }
user --> browser
browser --> wlan_router
wlan_router --> reverse_proxy
reverse_proxy --> nextcloud
reverse_proxy --> collabora
nextcloud --> db

@enduml
....

Let me short describe you this architecture briefly.

. The `user` that is connecting to nextcloud.
. He is using a `browser` (or any other device/app) to make a connection
. The browser connects to the `wlan_router` at your home. This is your
  only component with a public IP-address. The `wlan_router` is configured
  to link:https://en.wikipedia.org/wiki/Port_forwarding[forward every traffic]
  that it receives on its public IP-address on
  Port 443 (the HTTPS port) to the IP-address of you local machine that
  will host your Nextcloud installation on Port 443(to the `reverse_proxy`).
+
NOTE: If you are installing Nextcloud on a server that is directly
      connected to the internet, then this component does not exist,
      and the browser directly connects to the `reverse_proxy`. +
      In this case you of course also need not to configure the mentioned
      port forwarding.
. The `reverse_proxy` is receiving the incoming traffic. It
  will inspect the request to find out to which host it should forward the request to.
+
TIP: If you want to know how the `reverse_proxy` could do this, as the Request is
encrypted, you can read link:https://cwiki.apache.org/confluence/display/HTTPD/NameBasedSSLVHostsWithSNI[this].
(It is using link:https://en.wikipedia.org/wiki/Server_Name_Indication[SNI])
. The `nextcloud` node contains just what the name implies. The main
  program. It will store all your files locally to this.
. The `db` node is the database that is used by `nextcloud` to store everything but files
  (contacts, calendar, ...)
. `collabora` contains the office suite.

Everything that is depicted in the cloud `docker` will be installed on one (docker-)host.

== Setting it up
First of all, we will make sure traffic to our planned domains `cloud.dancier.net`
and `collabora.dancier.net` could reach our system.

=== Check your DNS/IP configuration

All incoming traffic has to reach the `reverse_proxy`. So the DNS should normally
point to the machine you are going to install the system.

TIP: In case you are installing the system on a host behind a `wlan-router`
     (as depicted in above architecture diagram)
     than you have to find out the public IP-address of the router. Use
     this IP-address to configure your DNS entries and forward all traffic
     that reaches your `wlan-router` on PORT 443 to the machine in your
     local net where you are going to install Nextcloud.
     +
     Google for <router brand/type> port forwarding how to do this.

Assuming that the public IP-address is `5.61.144.190` you should get
the following responses when invoking a `nslookup` on the domains:

[source, bash]
----
marc@marc-VirtualBox:~/programm/dancier/documentation$ nslookup cloud.dancier.net
Server:   127.0.0.53
Address:  127.0.0.53#53

Non-authoritative answer:
Name:	 cloud.dancier.net
Address: 5.61.144.190

marc@marc-VirtualBox:~/programm/dancier/documentation$ nslookup collabora.dancier.net
Server:   127.0.0.53
Address:  127.0.0.53#53

Non-authoritative answer:
Name:	 collabora.dancier.net
Address: 5.61.144.190
----

=== Installing basic tools that you need

You need the following tools on the server you are going to install Nextcloud.

 * docker
 * docker-compose
 * git
 * vim (not necessarily needed, but good to have ;-) )

You can install the tools on your own or you can download my script and
execute it with on a fresh Ubuntu-Host that should serve the Nextcloud installation.
If this script will not run on your system, it could give you hints how to install the tools.
The script is also already cloning the repository containing the docker setup for Nextcloud.
The next section will assume the script has been run successfully or at least you have
performed the equivalent steps manually.

Get the script here:

`https://raw.githubusercontent.com/gorzala/nextcloud/master/bootstrap-os.sh`

Copy this script to your server (or download it from there) and execute it.

=== Inspecting the project

Assuming you have already cloned the repository to `/root/nextcloud/`, let's inspect
the project structure:

[source, bash]
----
root@cloud:~/nextcloud# ls -la
total 48
drwxr-xr-x 4 root root 4096 Mar 20 14:28 .
drwx------ 6 root root 4096 Mar 20 14:28 ..
-rwxr-xr-x 1 root root 1113 Mar 20 14:28 bootstrap-os.sh
-rw-r--r-- 1 root root 2379 Mar 20 14:28 docker-compose.yml
-rwxr-xr-x 1 root root  119 Mar 20 14:28 .env-template
drwxr-xr-x 8 root root 4096 Mar 20 14:28 .git
-rw-r--r-- 1 root root   86 Mar 20 14:28 .gitignore
-rw-r--r-- 1 root root  305 Mar 20 14:28 .maintenance.config
-rwxr-xr-x 1 root root 3250 Mar 20 14:28 maintenance.sh
-rw-r--r-- 1 root root 5708 Mar 20 14:28 README.adoc
drwxr-xr-x 3 root root 4096 Mar 20 14:28 update
----

Brief description of the purpose of the files:

 * *bootstrap-os.sh* the script that you maybe already used to install basic tools for this project
 * *docker-compose.yml* configures all the containers that we use and how they work together
 * *.env-template* template for the config file that will hold your database credentials
 * *.git* and *.gitignore* git internals, you can ignore them
 * *.maintenance.config* configures how you will backup/update your system
 * *maintenance.sh* the script for doing a backup and update (not yet complete)
 * *README.adoc* very short explanation how to use this project
 * *update* folder that belongs to updating the system. Maybe not really needed.

Let's have a more in deep look into the files in the following sections. If you don't want to
_waste time_ understanding what you are doing and directly want to configure and start the system,
feel to skip to <<section-configuring-system>>. But I strongly recommmend that you come back to
read _and_ understand what you have configured.

==== Composing your services with docker-compose.yml
To understand what you are doing here, it is important you have some knowledge about docker-compose.

First of all, that name of the folder that contains the docker-compose file is *important*.
Docker-compose will use the name of this folder to create things like networks and others for you. If you have cloned the project like I told
you, this name is `nextcloud`.

So name of created networks and containers will start with this name. So better not change
the name of this folder.

In general, you can think of docker-compose as a way to configure different services that
should act together to fulfill a certain use case. In this case it is, having a full featured
Nextcloud installation with an office suite running.

The different services that we need to configure in this docker compose file are:

Traefik:: that acts as the reverse proxy, forwarding incoming requests to the different internal systems
Nextcloud:: that is our main component
Mysql database:: that stores all the data for and is used by the Nextcloud service
Collabora:: the service that is used to provide the office suite

So already 4 services!

Those services will communicate with each other as shown in figure 1. The service-to-service
communication happens via a private network that docker-compose will create. With this private
network, this communication between these services is shielded from the rest of the docker-host
(and with this also from the internet).

So let's see how these four services are configured:

NOTE: The compose-file is being written in link:https://yaml.org/[Yaml]-Syntax. This is becoming
      someway standard for more and more systems. So if you are not familiar with how to write
      YAML files, learning this will pay off not only for writing docker-compose files.

Let's see the basic structure of the docker-compose file:

.docker-compose.yml (schema)
[source, bash, linenumbers]
----
version: "3"
services:
  traefik:
    [...]
  nextcloud:
    [...]
  mysql:
    [...]
  collabora:
    [...]
----
* *line 1: version* +
  specifies that we are using version 3 of the file syntax. (This is not the version of docker-compose
  or docker)
* *line 2: introduces the services* +
  starts with the definitions of the services that we will use. The level under services, contains
  nodes for each service.

See in the following and deeper explanation for the configuration of each service:

===== Traefik
.docker-compose.yml (Traefik part)
[source, bash, linenumbers]
----
  traefik:
    image: "traefik:v2.0.0-rc3"
    command:
      - "--log.level=DEBUG"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.mytlschallenge.acme.tlschallenge=true"
      #- "--certificatesresolvers.mytlschallenge.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory"
      - "--certificatesresolvers.mytlschallenge.acme.email=marc@becheftigt.de"
      - "--certificatesresolvers.mytlschallenge.acme.storage=/letsencrypt/acme.json"
    restart: always
    ports:
      - "443:443"
      - "8080:8080"
    volumes:
      - "./letsencrypt:/letsencrypt"
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
----

configures traefik as the `reverse_proxy`

line 1:: set the service-name to traefik. As we do not specify a container name explicitly,
         docker-compose will generate this name: _nextcloud_traefik_1_. Compose will the take
         the name of the folder that contains the compose file, concatenates it with the name
         of the service and a number for that node(we will have only one noce per service, so
         this will be always 1)
line 4:: defines which link:https://hub.docker.com/_/traefik[docker image] to get for traefik
lines 5-14:: configures cli parameters for traefik +
         In short: the configuration of traefik is being grouped into static configuration
         (everything that changes rarely(are we working with docker, or kubernetes,...) and
         dynamic configuration for the stuff that changes more frequently. +
         For the static configuration traefik offers three ways:
* File based configuration
* Environment variable configuration.
* _Command line parameter bases configuration_ (I choose to use this option)

line 6:: *debug mode* +
    This command-line parameter configured traefik to start in debug mode. This will
     increase the logging volume heavily. Use this when you have problems.
     This is commented out in this example.
line 7:: *api insecure*
line 8:: *provider docker*
line 9:: *docker expose by default*
*** *line 10 entry points*
*** *line 11 tls-challenge* +
*** *line 12 staging*
*** *line 13 acme email*
*** *line 14 acme storage*
*** *line 15 - 17 ports to be exposed*
*** *line 18 - 20 volumes*

===== Nextcloud
.docker-compose.yml (Nextcloud part)
[source, bash, linenumbers]
----
  nextcloud:
    image: nextcloud
    environment:
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
    restart: always
    volumes:
      - ./nextcloud-core:/var/www/html
      - ./nextcloud-apps:/var/www/html/custom_apps
      - /mnt/nextcloud-data/:/var/www/html/data
      - ./nextcloud-config:/var/www/html/config
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nextcloud.rule=Host(`cloud.becheftigt.de`)"
      - "traefik.http.routers.nextcloud.entrypoints=websecure"
      - "traefik.http.routers.nextcloud.tls.certresolver=mytlschallenge"
      - "traefik.http.middlewares.nextcloud.headers.customresponseheaders.Strict-Transport-Security=max-age=15552000; includeSubDomains"
    depends_on:
      - mysql
      - traefik
----
** *line 24-46 nextcloud* +
** *line 24 -26 environement* +
    The nextcloud container will be configured via environment variables that are passed to the container.
*** *line 25* restart always
*** *lines 28 - 32 volumes*
*** *lines 33 - 38 labels*
**** *line 34 traefik.enable*
**** *line 35 rule*
**** *line 36 entrypoint*
**** *line 37 certresolver*
**** *line 38 Strict-Header*
*** *lines 39 - 40 depends on*



===== MySQL
.docker-compose.yml (MySQL part)
[source, bash, linenumbers]
----
  mysql:
    image: mariadb:latest
    command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW
    volumes:
      - ./nextcloud-mysql:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD
      - MYSQL_PASSWORD
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
----

===== Collabora
.docker-compose.yml (Collabora part)
[source, bash, linenumbers]
----
  collabora:
    image: collabora/code
    restart: always
    environment:
      - domain=cloud\\.becheftigt\\.de
      - extra_params=--o:ssl.enable=false --o:ssl.termination=true
    depends_on:
      - traefik
    cap_add:
      - MKNOD
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.collabora.rule=Host(`collabora.becheftigt.de`)"
      - "traefik.http.routers.collabora.entrypoints=websecure"
      - "traefik.http.routers.collabora.tls.certresolver=mytlschallenge"
----

====  Configuring your database credentials with .env-template

[source, bash, linenumbers]
----
MYSQL_ROOT_PASSWORD=<your-my-sql-root-passwort>
MYSQL_PASSWORD=<the password for accessing the database for nextcloud>
----

==== Maintaining the system with maintenance.sh

==== Configuring the backup with .maintenance.config
[source, bash, linenumbers]
----
BASE_FOLDER=/home/marc/programm/nextcloud
NEXTCLOUD_DATA_FOLDER=/mnt/nextcloud-data
LETSENCRYPT=letsencrypt
NEXTCLOUD_APPS=nextcloud-apps
NEXTCLOUD_CONFIG=nextcloud-config
NEXTCLOUD_CORE=nextcloud-core
NEXTCLOUD_MYSQL=nextcloud-mysql

BACKUP_FOLDER=/media/marc/0519a4be-d9ce-4725-81f3-a26d9e577d13/backup
----

[[section-configuring-system]]
=== Configuring the system





-- chang in config.php

'overwritehost' => 'cloud.becheftigt.de',
'overwriteprotocol' => 'https',
'overwrite.cli.url' => 'https://cloud.becheftigt.de',


for apple support

in nextcloud core.htaccess

RewriteRule ^\.well-known/host-meta https://%{HTTP_HOST}/public.php?service=host-meta [QSA,L]
RewriteRule ^\.well-known/host-meta\.json https://%{HTTP_HOST}/public.php?service=host-meta-json [QSA,L]
RewriteRule ^\.well-known/webfinger https://%{HTTP_HOST}/public.php?service=webfinger [QSA,L]
RewriteRule ^\.well-known/nodeinfo https://%{HTTP_HOST}/public.php?service=nodeinfo [QSA,L]
RewriteRule ^\.well-known/carddav https://%{HTTP_HOST}/remote.php/dav/ [R=301,L]
RewriteRule ^\.well-known/caldav https://%{HTTP_HOST}/remote.php/dav/ [R=301,L]




https://github.com/jowave/vcard2to3

2.1 3.1




172.18.0.0/16

cat 'trusted_proxies' => array('172.18.0.0/16'),

docker network inspect nextcloud_default ^


docker pull