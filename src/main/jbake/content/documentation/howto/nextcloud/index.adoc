= Setting up your own Nextcloud with Collabora Office
:jbake-type: page
:jbake-status: published
:jbake-tags: nextcloud, traefik, docker, docker-compose, collabora, code
:idprefix:

Author: Marc Gorzala

image::nextcloud-logo-white.png[align="center"]

This post explains how you _could_ setup your own link:https://nextcloud.com/[Nextcloud]
with link:https://www.collaboraoffice.com/code/[Collabora Office].


*What is Nextcloud?*

Nextcloud offers you to host a service like link:https://www.dropbox.com/[DropBox].
You can have you files synced between different devices like your Desktop/Laptop and
mobile.

You have also a calendar, a todo-list, your contacts and many other things synced
across your devices.

*What is Collabora?*

Collabora, offers you the functionality of link:https://www.libreoffice.org/[Libre Office]
in your browser. In this tutorial we will integrate Collabora in your Nextcloud
installation, so that you can edit office files directly in your Nextcloud!

*The installed system will...*

* ... use link:https://de.wikipedia.org/wiki/Hypertext_Transfer_Protocol_Secure[HTTPS]
  to make your communication with your Nextcloud secure.
* ... include the Office Suite  link:https://www.collaboraoffice.com/code/[Collabora Office]
* ... separate Code/App from your data, to make it easy for you to
** make backups (we will have a basic script for doing backups).
** perform updates.
* ... works behind a (DSL) router as well as on any other server in the cloud
  or elsewhere.

---

:toc:
:toc-placement: macro
toc::[]


== Prerequisites

* A server that runs link:https://www.linux.org/[Linux]
  (this post will assume you are using a Debian/Ubuntu based distribution).
* You can edit DNS entries for a domain you own. In this tutorial I will assume that
  you will use link:https://en.wikipedia.org/wiki/Subdomain[Subdomains] under `dancier.net`:
** `cloud.dancier.net` - pointing to your Nextcloud installation
** `collabora.dancier.net` - pointing to the installation of the office suite.
  (If you do not want to install the option for editing office files, you can also
skip this in this post)
+
NOTE: As this is an domain that I own, you have of course change this to your own domain.


* Basic knowledge of Linux and link:https://www.docker.com/[Docker].

== We will use the following technologies

* link:https://www.docker.com/[Docker] for easy installation/updating of the needed
       software. I will assume you have it link:https://docs.docker.com/install/linux/docker-ce/ubuntu/[installed].
* link:https://docs.docker.com/compose/[Docker Compose] for a convenient configuration
       of the docker containers. I will assume you have this installed too.
* link:https://docs.traefik.io/[Traefik] for automatically maintaining SSL Certificates,
       and forwarding Request to either Nextcloud of Collabora Online as an
       link:https://docs.docker.com/install/linux/docker-ce/ubuntu/[reverse proxy].
       We will install this in the course of this tutorial.
* link:https://mysql.com/[MySQL] to be used as the database for Nextcloud. This in the
       next item will also be installed.
* link:https://www.collaboraoffice.com/code/[Collabora Office]

== Architectural Overview
.architectural overview
[plantuml, cloud-architecture, svg]
....
@startuml
 left to right direction
 actor user
 component browser
 boundary wlan_router
 cloud docker {
   database db
   boundary reverse_proxy
   node nextcloud
   node collabora
 }
user --> browser
browser --> wlan_router
wlan_router --> reverse_proxy
reverse_proxy --> nextcloud
reverse_proxy --> collabora
nextcloud --> db

@enduml
....

Let me short describe you this architecture briefly.

. The `user` that is connecting to nextcloud.
. He is using a `browser` (or any other device) to make this connection
. The browser connects to the `wlan_router` at your home. This is your
  only component with a public IP-address. The `wlan_router` is configured
  to link:https://en.wikipedia.org/wiki/Port_forwarding[forward every traffic]
  that it receives on its public IP-address on
  Port 443 (the HTTPS port) to the IP-address of you local machine that
  will host your Nextcloud installation on Port 443(to the `reverse_proxy`).
+
NOTE: If you are installing Nextcloud on a server that is directly
      connected to the internet, then this component does not exist,
      and the browser directly connects to the `reverse_proxy`.
. The `reverse_proxy` is receiving the incoming traffic. It
  will inspect the request to find out to which host it should be forwarded.
+
TIP: If you want to know how the `reverse_proxy` could do this, as the Request is
encrypted, you can read link:https://cwiki.apache.org/confluence/display/HTTPD/NameBasedSSLVHostsWithSNI[this].
(It is using SNI)
. The `nextcloud` node contains just what the name implies. The main
  program. It will store all your files locally to this.
. The `db` node is the database that is used by `nextcloud` to store everything but files
  (contacts, calendar, ...)
. `collabora` contains the office suite.

Everything that is depicted in the cloud `docker`will be installed on one (docker-)host.

== Setting it up
First of all we will make sure that traffic to our planned domains `cloud.dancier.net`
and `collabora.dancier.net` could reach our system.

=== Check your DNS/IP configuration
All incoming traffic has to reach the `reverse_proxy`. So the DNS should normally
point to the machine you are going to install the system.

TIP: In case you are installing the system on a host behind a `wlan-router`
     than you have to find out the public IP-address of the router. Use than
     this IP-adress to configure your DNS entries and forward all traffic
     that reaches your `wlan-router` on PORT 443 to the machine in your
     local net where you going to install nextcloud.
     +
     Google for <router brand/type> port forwarding how to do this.

Assuming that the public IP-address is `5.61.144.190` you should get
the following responses when making an nslookup on the domains:

[source, bash]
----
marc@marc-VirtualBox:~/programm/dancier/documentation$ nslookup cloud.dancier.net
Server:   127.0.0.53
Address:  127.0.0.53#53

Non-authoritative answer:
Name:	 cloud.dancier.net
Address: 5.61.144.190

marc@marc-VirtualBox:~/programm/dancier/documentation$ nslookup collabora.dancier.net
Server:   127.0.0.53
Address:  127.0.0.53#53

Non-authoritative answer:
Name:	 collabora.dancier.net
Address: 5.61.144.190
----

=== Install
You can access all the code/config in via the following github-repository.

You can clone it, or recreate it on your own.

[source, bash]
----
git clone git@github.com:gorzala/nextcloud.git

----






-- chang in config.php

'overwritehost' => 'cloud.becheftigt.de',
'overwriteprotocol' => 'https',
'overwrite.cli.url' => 'https://cloud.becheftigt.de',


for apple support

in nextcloud core.htaccess

RewriteRule ^\.well-known/host-meta https://%{HTTP_HOST}/public.php?service=host-meta [QSA,L]
RewriteRule ^\.well-known/host-meta\.json https://%{HTTP_HOST}/public.php?service=host-meta-json [QSA,L]
RewriteRule ^\.well-known/webfinger https://%{HTTP_HOST}/public.php?service=webfinger [QSA,L]
RewriteRule ^\.well-known/nodeinfo https://%{HTTP_HOST}/public.php?service=nodeinfo [QSA,L]
RewriteRule ^\.well-known/carddav https://%{HTTP_HOST}/remote.php/dav/ [R=301,L]
RewriteRule ^\.well-known/caldav https://%{HTTP_HOST}/remote.php/dav/ [R=301,L]




https://github.com/jowave/vcard2to3

2.1 3.1




172.18.0.0/16

cat 'trusted_proxies' => array('172.18.0.0/16'),

docker network inspect nextcloud_default ^
