= Setting up your own Nextcloud with Collabora Office
:jbake-type: page
:jbake-status: published
:jbake-date: 2020-03-21
:jbake-tags: nextcloud, traefik, docker, docker-compose, collabora, code, cloud, letsencrypt,  ssl, office, backup, ubunutu, linux
:jbake-description: How to setup you Nextcloud with docker, traefik, Collabora, office and letsencrypt
:jbake-author: Marc Gorzala
:jbake-disqus_enabled: true
:jbake-disqus_identifier: f184187c-69d1-11ea-b388-87b974545588
:idprefix:

Author: Marc Gorzala

image::nextcloud-logo-white.png[align="center"]

This post explains how you _could_ setup your own link:https://nextcloud.com/[Nextcloud]
with link:https://www.collaboraoffice.com/code/[Collabora Office] having SSL automatically managed via
link:https://letsencrypt.org[Letsencrypt] and link:https://containo.us/traefik/[Traefik].


*What is Nextcloud?*

Nextcloud offers you to host a service like link:https://www.dropbox.com/[DropBox].

You can have you files synced between different devices like your Desktop/Laptop and
mobile. Additionally you have also a calendar, a todo-list, your contacts and many other things synced
across your devices.

*What is Collabora?*

link:https://www.collaboraoffice.com/code/[Collabora], offers you the functionality of link:https://www.libreoffice.org/[Libre Office]
in your browser. In this tutorial we will integrate Collabora into your Nextcloud
installation, so that you can edit office documents directly in your Nextcloud!

*The installed system will...*

* ... use link:https://de.wikipedia.org/wiki/Hypertext_Transfer_Protocol_Secure[HTTPS]
  to secure the communication with your Nextcloud.
* ... include the Office Suite  link:https://www.collaboraoffice.com/code/[Collabora Office]
* ... separate Code/App from your data, making it easy for you to
** make backups (we will have a basic script for doing backups).
** perform updates.
* ... works behind a (DSL) router as well as on any other server in the cloud
  or elsewhere.

Ready to go? Great!

---

:toc:
:toc-placement: macro
:toclevels: 4
toc::[]


== Prerequisites

* A server that is able to run link:https://www.linux.org/[Linux]
  (this post will assume you are using a Debian/Ubuntu based distribution).
* You have control over DNS entries for a domain that you own. In this tutorial I will assume that
  you will use link:https://en.wikipedia.org/wiki/Subdomain[Subdomains] under `dancier.net`:
** `cloud.dancier.net` - pointing to your Nextcloud installation
** `collabora.dancier.net` - pointing to the installation of the office suite.
  (If you do not want to install the option for editing office files, you do not need this of course)
+
NOTE: The way we are installing the system is that everything is installed on the same machine
      and we need only one IP-address. So both domain names point to this one address.


* Basic knowledge of link:https://en.wikipedia.org/wiki/Linux[Linux] and link:https://www.docker.com/[Docker].

== We will use the following technologies

* link:https://www.docker.com/[Docker] for easy installation/updating of the needed
       software.
* link:https://docs.docker.com/compose/[Docker Compose] for a convenient configuration
       of the docker containers.
* link:https://docs.traefik.io/[Traefik] for automatically maintaining SSL Certificates
       and forwarding requests to either Nextcloud or Collabora Online. In this way it acts
       as an link:https://docs.docker.com/install/linux/docker-ce/ubuntu/[Reverse Proxy].
* link:https://mysql.com/[MySQL] to be used as the database for Nextcloud.
* link:https://www.collaboraoffice.com/code/[Collabora Office]

== Architectural Overview
[[architectural-overview]]
.architectural overview
[plantuml, cloud-architecture, svg]
....
@startuml
 left to right direction
 actor user
 component browser
 boundary wlan_router
 cloud docker {
   database db
   boundary reverse_proxy
   node nextcloud
   node collabora
 }
user --> browser
browser --> wlan_router
wlan_router --> reverse_proxy
reverse_proxy --> nextcloud
reverse_proxy --> collabora
nextcloud --> db

@enduml
....

Let me short describe you this architecture briefly.

. The `user` that is connecting to nextcloud.
. He is using a `browser` (or any other device/app) to make a connection
. The browser connects to the `wlan_router` at your home. This is your
  only component with a public IP-address. The `wlan_router` is configured
  to link:https://en.wikipedia.org/wiki/Port_forwarding[forward every traffic]
  that it receives on its public IP-address on
  Port 443 (the HTTPS port) to the IP-address of you local machine that
  will host your Nextcloud installation on Port 443(to the `reverse_proxy`).
+
NOTE: If you are installing Nextcloud on a server that is directly
      connected to the internet, then this component does not exist,
      and the browser directly connects to the `reverse_proxy`. +
      In this case you of course also need not to configure the mentioned
      port forwarding.
. The `reverse_proxy` is receiving the incoming traffic. It
  will inspect the request to find out to which host it should forward the request to.
+
TIP: If you want to know how the `reverse_proxy` could do this, as the Request is
encrypted, you can read link:https://cwiki.apache.org/confluence/display/HTTPD/NameBasedSSLVHostsWithSNI[this].
(It is using link:https://en.wikipedia.org/wiki/Server_Name_Indication[SNI])
. The `nextcloud` node contains just what the name implies. The main
  program. It will store all your files locally to this.
. The `db` node is the database that is used by `nextcloud` to store everything but files
  (contacts, calendar, ...)
. `collabora` contains the office suite.

Everything that is depicted in the cloud `docker` will be installed on one (docker-)host.

== Setting it up
First of all, we will make sure traffic to our planned domains `cloud.dancier.net`
and `collabora.dancier.net` could reach our system.

=== Check your DNS/IP configuration

All incoming traffic has to reach the `reverse_proxy`. So the DNS should normally
point to the machine you are going to install the system.

TIP: In case you are installing the system on a host behind a `wlan-router`
     (as depicted in above architecture diagram)
     than you have to find out the public IP-address of the router. Use
     this IP-address to configure your DNS entries and forward all traffic
     that reaches your `wlan-router` on PORT 443 to the machine in your
     local net where you are going to install Nextcloud.
     +
     Google for <router brand/type> port forwarding how to do this.

Assuming that the public IP-address is `5.61.144.190` you should get
the following responses when invoking a `nslookup` on the domains:

[source, bash]
----
marc@marc-VirtualBox:~/programm/dancier/documentation$ nslookup cloud.dancier.net
Server:   127.0.0.53
Address:  127.0.0.53#53

Non-authoritative answer:
Name:	 cloud.dancier.net
Address: 5.61.144.190

marc@marc-VirtualBox:~/programm/dancier/documentation$ nslookup collabora.dancier.net
Server:   127.0.0.53
Address:  127.0.0.53#53

Non-authoritative answer:
Name:	 collabora.dancier.net
Address: 5.61.144.190
----

=== Installing basic tools that you need

You need the following tools on the server you are going to install Nextcloud.

 * docker
 * docker-compose
 * git
 * vim (not necessarily needed, but good to have ;-) )

You can install the tools on your own or you can download my script and
execute it with on a fresh Ubuntu-Host that should serve the Nextcloud installation.
If this script will not run on your system, it could give you hints how to install the tools.
The script is also already cloning the repository containing the docker setup for Nextcloud.
The next section will assume the script has been run successfully or at least you have
performed the equivalent steps manually.

Get the script here:

`https://raw.githubusercontent.com/gorzala/nextcloud/master/bootstrap-os.sh`

Copy this script to your server (or download it from there) and execute it.

=== Inspecting the project

Assuming you have already cloned the repository to `/root/nextcloud/`, let's inspect
the project structure:

[source, bash]
----
root@cloud:~/nextcloud# ls -la
total 48
drwxr-xr-x 4 root root 4096 Mar 20 14:28 .
drwx------ 6 root root 4096 Mar 20 14:28 ..
-rwxr-xr-x 1 root root 1113 Mar 20 14:28 bootstrap-os.sh
-rw-r--r-- 1 root root 2379 Mar 20 14:28 docker-compose.yml
-rwxr-xr-x 1 root root  119 Mar 20 14:28 .env-template
drwxr-xr-x 8 root root 4096 Mar 20 14:28 .git
-rw-r--r-- 1 root root   86 Mar 20 14:28 .gitignore
-rw-r--r-- 1 root root  305 Mar 20 14:28 .maintenance.config
-rwxr-xr-x 1 root root 3250 Mar 20 14:28 maintenance.sh
-rw-r--r-- 1 root root 5708 Mar 20 14:28 README.adoc
drwxr-xr-x 3 root root 4096 Mar 20 14:28 update
----

Brief description of the purpose of the files:

 * *bootstrap-os.sh* the script that you maybe already used to install basic tools for this project
 * *docker-compose.yml* configures all the containers that we use and how they work together
 * *.env-template* template for the config file that will hold your database credentials
 * *.git* and *.gitignore* git internals, you can ignore them
 * *.maintenance.config* configures how you will backup/update your system
 * *maintenance.sh* the script for doing a backup and update (not yet complete)
 * *README.adoc* very short explanation how to use this project
 * *update* folder that belongs to updating the system. Maybe not really needed.

Let's have a more in deep look into the files in the following sections. If you don't want to
_waste time_ understanding what you are doing and directly want to configure and start the system,
feel to skip to <<section-configuring-system>>. But I strongly recommmend that you come back to
read _and_ understand what you have configured.

==== Composing your services with docker-compose.yml
To understand what you are doing here, it is important you have some knowledge about docker-compose.

First of all, that name of the folder that contains the docker-compose file is *important*.
Docker-compose will use the name of this folder to create things like networks and others for you. If you have cloned the project like I told
you, this name is `nextcloud`.

So name of created networks and containers will start with this name. So better not change
the name of this folder.

In general, you can think of docker-compose as a way to configure different services that
should act together to fulfill a certain use case. In this case it is, having a full featured
Nextcloud installation with an office suite running.

The different services that we need to configure in this docker compose file are:

Traefik:: that acts as the reverse proxy, forwarding incoming requests to the different internal systems
Nextcloud:: that is our main component
Mysql database:: that stores all the data for and is used by the Nextcloud service
Collabora:: the service that is used to provide the office suite

So already 4 services!

Those services will communicate with each other as shown in figure 1. The service-to-service
communication happens via a private network that docker-compose will create. With this private
network, this communication between these services is shielded from the rest of the docker-host
(and with this also from the internet).

So let's see how these four services are configured:

NOTE: The compose-file is being written in link:https://yaml.org/[Yaml]-Syntax. This is becoming
      someway standard for more and more systems. So if you are not familiar with how to write
      YAML files, learning this will pay off not only for writing docker-compose files.

Let's see the basic structure of the docker-compose file:

.docker-compose.yml (schema)
[source, bash, linenumbers]
----
version: "3"
services:
  traefik:
    [...]
  nextcloud:
    [...]
  mysql:
    [...]
  collabora:
    [...]
----
* *line 1: version* +
  specifies that we are using version 3 of the file syntax. (This is not the version of docker-compose
  or docker)
* *line 2: introduces the services* +
  starts with the definitions of the services that we will use. The level under services, contains
  nodes for each service.

In the following we will have a deeper look onto the configuration of each service:

===== Traefik
.docker-compose.yml (Traefik part)
[source, bash, linenumbers]
----
  traefik:
    image: "traefik:v2.0.0-rc3"
    command:
      - "--log.level=DEBUG"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.mytlschallenge.acme.tlschallenge=true"
      #- "--certificatesresolvers.mytlschallenge.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory"
      - "--certificatesresolvers.mytlschallenge.acme.email=marc@becheftigt.de"
      - "--certificatesresolvers.mytlschallenge.acme.storage=/letsencrypt/acme.json"
    restart: always
    ports:
      - "443:443"
    volumes:
      - "./letsencrypt:/letsencrypt"
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
----

This part configures Traefik, which is our `reverse_proxy`, that forwards all incoming
requests to the other services (see <<architectural-overview>>).

line 1:: Sets the service-name to 'traefik'. As we do not specify a container name explicitly,
         docker-compose will generate this name: _nextcloud_traefik_1_. Compose will the take
         the name of the folder that contains the compose file, concatenates it with the name
         of the service and a number for that node(we will have only one noce per service, so
         this will be always 1)
line 2:: defines which link:https://hub.docker.com/_/traefik[docker image] to get for traefik
lines 4-11:: configures cli parameters for traefik +
         In short: the configuration of traefik is being grouped into static configuration
         (everything that changes rarely(are we working with docker, or kubernetes,...) and
         dynamic configuration for the stuff that changes more frequently. +
         For the static configuration traefik offers three ways:
* File based configuration
* Environment variable configuration.
* _Command line parameter bases configuration_ (I choose to use this option)

line 4:: *debug log level* +
         This command-line parameter configured traefik to start in debug mode. This will
         increase the logging volume heavily. Use this when you have problems.
         This is commented out in this example.
line 5:: *provider docker* +
         This will setup traefik to use the docker-plugin, the provider. Essentially this,
         makes Traefik listen to every container that is started/stopped by Docker.
         Whenever a container starts, it checks if this container is being configured to
         used with Traefik. If so, it creates a route so that incoming traffic will be
         forworded to this service/container. It will also make sure that a valid
         ssl-certifcate is being used.
line 6:: *docker expose by default*
         you explizitly have to enable containers so that they will be handled by traefik.
line 7:: *entry points*
         makes traefik to create an endpoint names websecure that listens on port 443. traefik will
         use this endpoint to handle all incoming traefik in route it to the respective containers
         (see figure one what is menat with this)
line 8-11:: ssl-configuration* +
         configures how traefik should manage certifcates
line 12:: restart always
line 13 - 14:: ports to be exposed*
         We will only expose (listing on that port on the docker-host) the port 443. This is the
         default for for https/ssl
line 15 - 17:: *link:https://docs.docker.com/storage/volumes/[Volumes]*
         * the letsencrypt volume is used to store the ssl certificate related things
         * docker link:https://en.wikipedia.org/wiki/Unix_domain_socket[socket] is someway special: +
           it enables the traefik container to connect to the mentioned socket on the docker-host.
           By connecting to this socket, Traefik is aware of all containers that are started and stopped.
           You will see later why this is important.

===== Nextcloud
.docker-compose.yml (Nextcloud part)
[source, bash, linenumbers]
----
  nextcloud:
    image: nextcloud
    environment:
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
    restart: always
    volumes:
      - ./nextcloud-core:/var/www/html
      - ./nextcloud-apps:/var/www/html/custom_apps
      - /mnt/nextcloud-data/:/var/www/html/data
      - ./nextcloud-config:/var/www/html/config
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nextcloud.rule=Host(`cloud.dancier.net`)"
      - "traefik.http.routers.nextcloud.entrypoints=websecure"
      - "traefik.http.routers.nextcloud.tls.certresolver=mytlschallenge"
      - "traefik.http.middlewares.nextcloud.headers.customresponseheaders.Strict-Transport-Security=max-age=15552000; includeSubDomains"
    depends_on:
      - mysql
      - traefik
----
line 1:: Sets the name of the service to 'nextcloud'.
line 3-5:: Environment
    We are passing two environment variables into the Nextcloud-container:
    * we are setting the database name to be used to 'nextcloud'
    * we are setting the database username to be used also to 'nextcloud'
lines 7 - 11:: *volumes*
 * nextcloud-core, this will contain the core part of nextcloud
 * nextcloud-app, this will hold your installed apps (kind of extensions of nextcloud)
 * nextcloud-data, this very likely to be the volume that has to store most because all the
   files that you will handle by nextcloud will be stored here. I pointed this to a path, where I mounted
   an external hard disk, that i dedicated to my nextcloud installation. This is also the only volume with an
   absolute path. All other volumes from this service will have relative path and
 * nextcloud-config, this will contain the configuration files the will be read by Nextcloud

lines 12 - 17:: *labels*
* *traefik.enable* +
   as I told you in the description of the Traefik-Service, Traefik will be informed by every start and stop of a
   docker container. I will also be able to read the labels associated with the containers. By reading this lable,
   we tell traefik to feel responsible to this service.
* *rule* +
   This is also read by traefik and tell Traefik to forward all traffic has the http-host header set to
  'cloud.dancier.net' to this service
* *entrypoint* +
   Traefik will use this named endpoint (see configuration for Traefik) to consider traffic for Nextcloud
* *certresolver*
   Says which certifcate-generation strategy should be used (we configured also this in the Traefik-part)
* *Strict-Header*
  *Tried to circumvent an error message in the nextcloud backend*

lines 18 - 20:: *depends on*
    * Nextcloud needs to have traefik running before being started, as traefik would not be able to configure ssl when it
    starts after nextcloud
    * Nextcloud needs a running database, so we also wait until this is started.

===== MySQL
.docker-compose.yml (MySQL part)
[source, bash, linenumbers]
----
  mysql:
    image: mariadb:latest
    command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW
    volumes:
      - ./nextcloud-mysql:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD
      - MYSQL_PASSWORD
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
----
line 3::  https://dev.mysql.com/doc/refman/8.0/en/innodb-transaction-isolation-levels.html
lines 6 - 10:: *Environment* +
You, should notice that we configure 4 environment variables here.
Two of them already with a an concret value
 * MYSQL_DATABASE=nextcloud
 * MYSQL_USER=nextcloud
+
This, configures MYSQL to create a database named nextcloud with a user with the same name, that has all rights.
The creation of the database happens only when a database with this name not already exist.
The passwords for these tasks are taken from the next two environment variables.
 * MYSQL_ROOT_PASSWORD
 * MYSQL_PASSWORD
+
They do not have any values. In this case docker compose will take them from a file called `.env` from the
current directory (this could also be overwritten by cli parameters, but in our case we do not care for that option).
In the configuration part, I will tell you how to set this file up.

===== Collabora
.docker-compose.yml (Collabora part)
[source, bash, linenumbers]
----
  collabora:
    image: collabora/code
    restart: always
    environment:
      - domain=cloud\\.dancier\\.net
      - extra_params=--o:ssl.enable=false --o:ssl.termination=true
    depends_on:
      - traefik
    cap_add:
      - MKNOD
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.collabora.rule=Host(`collabora.dancier.net`)"
      - "traefik.http.routers.collabora.entrypoints=websecure"
      - "traefik.http.routers.collabora.tls.certresolver=mytlschallenge"
----
lines 4 - 6:: Environment
              * domain
              * extra_params
lines 8::     depends on traefik
lines 9-10::  capp_add MKNOD
lines 11-15:: lables


[[database-config]]
====  Configuring your database credentials with .env-template

[source, bash, linenumbers]
----
MYSQL_ROOT_PASSWORD=<your-my-sql-root-passwort>
MYSQL_PASSWORD=<the password for accessing the database for nextcloud>
----
This file is only a template, you should copy it into `.env`, see LATER

==== Maintaining the system with maintenance.sh

==== Configuring the backup with .maintenance.config
[source, bash, linenumbers]
----
BASE_FOLDER=/home/marc/programm/nextcloud
NEXTCLOUD_DATA_FOLDER=/mnt/nextcloud-data
LETSENCRYPT=letsencrypt
NEXTCLOUD_APPS=nextcloud-apps
NEXTCLOUD_CONFIG=nextcloud-config
NEXTCLOUD_CORE=nextcloud-core
NEXTCLOUD_MYSQL=nextcloud-mysql

BACKUP_FOLDER=/media/marc/0519a4be-d9ce-4725-81f3-a26d9e577d13/backup
----

[[section-configuring-system]]
=== Configuring the system

-- chang in config.php

'overwritehost' => 'cloud.becheftigt.de',
'overwriteprotocol' => 'https',
'overwrite.cli.url' => 'https://cloud.becheftigt.de',


for apple support

in nextcloud core.htaccess

RewriteRule ^\.well-known/host-meta https://%{HTTP_HOST}/public.php?service=host-meta [QSA,L]
RewriteRule ^\.well-known/host-meta\.json https://%{HTTP_HOST}/public.php?service=host-meta-json [QSA,L]
RewriteRule ^\.well-known/webfinger https://%{HTTP_HOST}/public.php?service=webfinger [QSA,L]
RewriteRule ^\.well-known/nodeinfo https://%{HTTP_HOST}/public.php?service=nodeinfo [QSA,L]
RewriteRule ^\.well-known/carddav https://%{HTTP_HOST}/remote.php/dav/ [R=301,L]
RewriteRule ^\.well-known/caldav https://%{HTTP_HOST}/remote.php/dav/ [R=301,L]




https://github.com/jowave/vcard2to3

2.1 3.1




172.18.0.0/16

cat 'trusted_proxies' => array('172.18.0.0/16'),

docker network inspect nextcloud_default ^


docker pull